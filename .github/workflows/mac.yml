name: MacOS 编译
on:
  workflow_dispatch:
    inputs:
      branch:
        type: string
        default: main
        description: "分支名"

jobs:
  bundle-mac:
    timeout-minutes: 60
    name: macOS 编译
    runs-on: macos-latest
    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0
      RUST_BACKTRACE: 1
    steps:
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: 设置 Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 当前仓库（用于 replace.py）
      - name: Checkout 当前仓库
        uses: actions/checkout@v4

      - name: 同步 zed 源代码
        uses: actions/checkout@v4
        with:
          repository: zed-industries/zed
          ref: ${{ inputs.branch }}
          path: zed

      - name: 执行替换脚本
        run: python3 replace.py

      - name: 压缩 zed 目录
        run: zip -r zed.zip zed

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: zed-macos
          path: zed.zip
